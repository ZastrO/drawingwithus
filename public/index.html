<!doctype html>
<html>
	<head>
		<title>Drawing With Us!</title>
		<link rel="stylesheet" href="/css/style.css">
	</head>
	<body>
		<canvas id="canvas" width="1170" height="800"></canvas>
		<ul class="userList"></ul>
		<div class="controls">
			<select class="control" id="brush">
				<option value="line">Line</option>
				<option value="dynaline">Dynamic Line</option>
				<option value="triline">Tri Line</option>
				<option value="squiggle10">Squiggle ^10</option>
				<option value="squiggle25">Squiggle ^25</option>
				<option value="spray">Spray</option>
				<!-- <option value="test">Test</option> -->
				<option value="circle">Circle</option>
				<option value="spraycircle">Circle Spray</option>
				<option value="scattercircles">Scattered Circles</option>
				<option value="sketchy">Sketchy</option>
			</select>
			<select class="control" id="room">
				<option value="lobby1">Lobby 1</option>
				<option value="lobby2">Lobby 2</option>
				<option value="lobby3">Lobby 3</option>
			</select>
			<form id="chat">
				<input class="control" id="msg" type="text" placeholder="message">
				<input type="submit" value="Send">
			</form>
			<div id="msgBox"></div>
		</div>
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
		<script>
			if(typeof sessionStorage.id === 'undefined'){
				sessionStorage.id = Math.floor(Math.random()*1000000);
			}
			if(typeof localStorage.room === 'undefined'){
				localStorage.room = 'lobby1';
			}
			
			var room = localStorage.room;
			$('#room').val(room);
			var id = sessionStorage.id;

			if( navigator.userAgent.indexOf("Chrome/") > 0 ) {
				localStorage.name = "Chrome";
			} else if( navigator.userAgent.indexOf("Safari/") > 0 ) {
				localStorage.name = "Safari";
			} else if( navigator.userAgent.indexOf("Firefox/") > 0 ) {
				localStorage.name = "FireFox";
			} else if( navigator.userAgent.indexOf(".NET") > 0 ) {
				localStorage.name = "Explorer";
			}

			if(typeof localStorage.name == 'undefined'){
				localStorage.name = prompt("What would you like to appear to other users as?","Choose a Nickname");
			}
			var name = localStorage.name;
			
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');
			context.lineJoin = 'round';
			context.lineCap = 'round';
			
			var lastXY = {x:false,y:false};
			var users = [];
			
			users[id] = {name:name,brush: 'line', x:0, y:0, lastX:null, lastY:null,room:room };
			
			var brushes = {
				line: function(user,x,y,options){
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(x, y);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				},
				triline: function(user,x,y,options){
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(x, y);
					context.moveTo(user.lastX-5, user.lastY-5);
					context.lineTo(x-5, y-5);
					context.moveTo(user.lastX+5, user.lastY+5);
					context.lineTo(x+5, y+5);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				},
				squiggle10: function(user,x,y,options){
					var randXY = {x: x-Math.floor(Math.random()*10),y: y-Math.floor(Math.random()*10)};
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(randXY.x, randXY.y);
					context.stroke();
					
					user.lastX = randXY.x;
					user.lastY = randXY.y;
				},
				squiggle25: function(user,x,y,options){
					var randXY = {x: x-Math.floor(Math.random()*25),y: y-Math.floor(Math.random()*25)};
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(randXY.x, randXY.y);
					context.stroke();
					
					user.lastX = randXY.x;
					user.lastY = randXY.y;
				},
				sketchy: function(user,x,y,options){
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(x, y);
					context.moveTo(user.lastX-Math.floor(Math.random()*5), user.lastY-Math.floor(Math.random()*5));
					context.lineTo(x, y);
					context.moveTo(user.lastX+Math.floor(Math.random()*5), user.lastY+Math.floor(Math.random()*5));
					context.lineTo(x, y);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				},
				dynaline: function(user,x,y,options){
					var xmax = Math.max(x,user.lastX);
					var ymax = Math.max(y,user.lastY);
					var xmin = Math.min(x,user.lastX);
					var ymin = Math.min(y,user.lastY);
					
					var xdif = xmax-xmin, ydif = ymax-ymin;
					
					if( (xdif >= 50) || (ydif >= 50) ){
						context.lineWidth = 1;
					} else if( (xdif > 40) || (ydif > 40) ){
						context.lineWidth = 2;
					} else if( (xdif > 30) || (ydif > 30) ){
						context.lineWidth = 3;
					} else if( (xdif > 20) || (ydif > 20) ){
						context.lineWidth = 4;
					} else if( (xdif <= 19) || (ydif <= 19) ){
						context.lineWidth = 5;
					}
					//console.log(xdif,ydif)
					
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(x,y);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				},
				circle: function(user,x,y,options){
					context.beginPath();
					context.arc(x, y, 3, 0, 2 * Math.PI, false);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				},
				scattercircles: function(user,x,y,options){
					context.beginPath();
					context.arc(x, y, Math.floor(Math.random()*5), Math.random()*2 * Math.PI, Math.random()*2 * Math.PI, false);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				},
				spraycircle: function(user,x,y,options){
					var spraysize = Math.floor(Math.random()*5);
					for(var i = 0; i<spraysize; i++){
						var randXY = {x: x-Math.floor(Math.random()*25),y: y-Math.floor(Math.random()*25)};
						context.beginPath();
						context.arc(randXY.x, randXY.y, Math.floor(Math.random()*5), 0, 2 * Math.PI, false);
						context.stroke();
					}
					user.lastX = x;
					user.lastY = y;
				},
				spray: function(user,x,y,options){
					var spraysize = Math.floor(Math.random()*5)+5;
					for(var i = 0; i<spraysize; i++){
						var randXY = {x: x-Math.floor(Math.random()*25),y: y-Math.floor(Math.random()*25)};
						context.beginPath();
						context.fillRect(randXY.x, randXY.y, 1, 1);
						context.stroke();
					}
					user.lastX = x;
					user.lastY = y;
				}/*,
				test: function(user,x,y,options){
					context.beginPath();
					context.moveTo(user.lastX, user.lastY);
					context.lineTo(x, y);
					context.stroke();
					
					user.lastX = x;
					user.lastY = y;
				}*/
			};
			
			function draw(x,y,id,brush){
				var user = users[id];
				var offset = $('#canvas').offset();
				/*var xOffset = ($('body').width() - canvas.width) / 2;*/
				x = (x - offset.left);
				y = (y - offset.top);
				
				context.fillStyle = '#'+id;
				context.lineWidth = 2;
				context.strokeStyle = '#'+id;
				/*context.fillRect(x,y,3,3);*/
				if( !user.lastX && !user.lastY ){
						context.beginPath();
						context.moveTo(x, y);
						user.lastX = x;
						user.lastY = y;
				} else {
					brushes[brush](user,x,y);
				}
				
			}
			
			var socket = io();
			var drawNow = false;
			
			socket.emit('init', {id:id, name:name, room:users[id].room});
			
			$('#brush').change(function(e){
				var val = $(e.target).val();
				console.log('Brush',val);
				users[id].brush = val;
			});
			
			$('#room').change(function(e){
				var val = $(e.target).val();
				localStorage.room = val;
				socket.emit('room',{user:id,name:name,roomFrom:room,roomTo:$(e.target).val()});
				room = val;
			});
			
			$('#chat').submit(function(e){
				e.preventDefault();
				var val = $(e.target).find('#msg').val();
				socket.emit('chat',{user:id,name:name,room:room,msg:val});
				$(e.target).find('#msg').val('')
				$('#msgBox').append('<div class="msgBubble" style="position:absolute; text-align: center; width: 100%;" >'+val+'</div>');
				$('#msgBox .msgBubble:last-of-type').animate(
					{
						top: '-150px',
						opacity: '0'
					},
					5000,
					function(){
						$(this).remove();
					}
				);
			});
			
			$('body').mousedown(function(){ drawNow = true; });
			$('body').mouseup(function(){ drawNow = false; users[id].lastX = false; users[id].lastY = false; });
			
			$('#canvas').mousemove(function(e){
	
				if(drawNow){
					draw(e.clientX,e.clientY,id,users[id].brush);
				}
				socket.emit('coordinates', {id:id,name:name,brush:users[id].brush,drawNow:drawNow,x:e.clientX,y:e.clientY, room:users[id].room});
			});
			
			socket.on('chat', function(data){
				console.log(data);
				$('.mouse_'+data.user+' .message').stop().css('opacity','1').show().html(data.msg);
				$('.mouse_'+data.user+' .message').fadeOut(5000); 

			});

			socket.on('cursor', function(data){
				if( ($('.mouse_'+data.id).length < 1) && (data.room == users[id].room) && (data.id != id) ){
					users[data.id] = {name:data.name,brush:data.brush, x:data.x, y:data.y, lastX:null, lastY:null, room:data.room };
					$('body').append($('<div class="mouse_'+data.id+'" data-name="'+data.name+'" style="top:'+data.y+'px;left:'+data.x+'px;"><img src="/images/pencil.png" ><div class="message"></div></div>'));
				} else if (data.room == users[id].room) {
					$('.mouse_'+data.id).css({
						'top': (data.y-16)+'px',
						'left': data.x+'px'
					});
				} else if (data.room != users[id].room) {
					$('.mouse_'+data.id).remove();
				}
				
				if(data.drawNow){
					draw(data.x,data.y,data.id,data.brush);
				} else {
					users[data.id].lastX = false;
					users[data.id].lastY = false;
				}
			});

			socket.on('users', function(data) {
				$('.userList').empty();
				$.each(data, function() {
					$('.userList').append('<li>'+this.name+'<div style="width: 20px; height: 10px; background: #'+this.id+';" title="#'+this.id+'"></div></li>');
				});
			});
			
			setInterval(function(){
				context.fillStyle = 'rgba(255,255,255,.05)';
				context.fillRect( 0, 0, $(canvas).width(), $(canvas).height());
			}, 1500);


			window.onbeforeunload = closingCode;
			function closingCode(){
				socket.emit('exit',{user:id,name:name,roomFrom:room});
			   return null;
			}
		</script>
	</body>
</html>